# @courses/common - Analysis & Recommendations

## üìä Current State

### ‚úÖ What's Implemented

1. **Error Classes** (`errors/app-error.ts`)
   - ‚úÖ AppError base class
   - ‚úÖ ValidationError
   - ‚úÖ AuthenticationError
   - ‚úÖ AuthorizationError
   - ‚úÖ NotFoundError
   - ‚úÖ ConflictError
   - ‚úÖ RateLimitError

2. **Middleware** 
   - ‚úÖ Error handler (`middleware/error-handler.ts`)
   - ‚úÖ Request logger (`middleware/request-logger.ts`)

3. **Base Validators** (`validators/base.validator.ts`)
   - ‚úÖ emailSchema
   - ‚úÖ passwordSchema
   - ‚úÖ uuidSchema
   - ‚úÖ paginationSchema
   - ‚úÖ querySchema

### ‚ùå What's Missing

#### **Critical (High Priority)**

1. **Unused Scaffold Files**
   - ‚ùå `lib/common.ts` - Remove
   - ‚ùå `lib/common.spec.ts` - Remove

2. **Authentication Middleware**
   - ‚ùå JWT verification middleware
   - ‚ùå Token extraction helper
   - ‚ùå User context injection

3. **Authorization Middleware**
   - ‚ùå Role-based access control (RBAC)
   - ‚ùå Permission checking
   - ‚ùå Resource ownership validation

4. **Course-Specific Validators**
   - ‚ùå Course creation/update schemas
   - ‚ùå Enrollment validation
   - ‚ùå Quiz/Assignment schemas
   - ‚ùå Payment validation

5. **Test Coverage**
   - ‚ùå No tests for error classes
   - ‚ùå No tests for middleware
   - ‚ùå No tests for validators

#### **Important (Medium Priority)**

6. **Additional Middleware**
   - ‚ùå Rate limiting middleware
   - ‚ùå CORS configuration
   - ‚ùå Request ID middleware
   - ‚ùå Body size limiter

7. **Response Builders**
   - ‚ùå Success response helper
   - ‚ùå Paginated response helper
   - ‚ùå Error response builder

8. **Validation Helpers**
   - ‚ùå Custom validators (slug, phone, etc.)
   - ‚ùå Array validation helpers
   - ‚ùå Date range validators

9. **File Upload Utilities**
   - ‚ùå File type validation
   - ‚ùå File size validation
   - ‚ùå Multipart form handling

#### **Nice to Have (Low Priority)**

10. **Cache Utilities**
    - ‚ùå Cache key generator
    - ‚ùå Cache wrapper functions

11. **API Versioning**
    - ‚ùå Version extraction middleware
    - ‚ùå Version-based routing helpers

---

## üéØ Recommendations

### **Phase 1: Essential Features (Do Now)**

#### 1. Remove Unused Files
```bash
rm libs/common/src/lib/common.ts
rm libs/common/src/lib/common.spec.ts
```

#### 2. Add Authentication Middleware
```typescript
// src/middleware/auth.middleware.ts
import { FastifyRequest, FastifyReply } from 'fastify';
import { AuthenticationError } from '../errors/app-error';

export interface AuthUser {
  userId: string;
  email: string;
  role: string;
  sessionId: string;
}

declare module 'fastify' {
  interface FastifyRequest {
    user?: AuthUser;
  }
}

export async function authenticate(
  request: FastifyRequest,
  reply: FastifyReply
) {
  try {
    const token = extractToken(request.headers.authorization);
    
    if (!token) {
      throw new AuthenticationError('AUTH_1007' as any, 'No token provided');
    }

    const decoded = await verifyJWT(token);
    request.user = decoded;
  } catch (error) {
    throw new AuthenticationError('AUTH_1007' as any, 'Invalid token');
  }
}

function extractToken(authHeader?: string): string | null {
  if (!authHeader) return null;
  
  const parts = authHeader.split(' ');
  if (parts.length === 2 && parts[0] === 'Bearer') {
    return parts[1];
  }
  
  return null;
}

async function verifyJWT(token: string): Promise<AuthUser> {
  // Implementation depends on your JWT library
  // This is a placeholder
  return {} as AuthUser;
}
```

#### 3. Add Authorization Middleware
```typescript
// src/middleware/authorize.middleware.ts
import { FastifyRequest, FastifyReply } from 'fastify';
import { AuthorizationError } from '../errors/app-error';
import { Role, hasPermission } from '@courses/shared';

export function requireAuth(
  request: FastifyRequest,
  reply: FastifyReply
) {
  if (!request.user) {
    throw new AuthorizationError('Authentication required');
  }
}

export function requireRole(...roles: Role[]) {
  return async (request: FastifyRequest, reply: FastifyReply) => {
    if (!request.user) {
      throw new AuthorizationError('Authentication required');
    }
    
    if (!roles.includes(request.user.role as Role)) {
      throw new AuthorizationError(
        `Requires one of: ${roles.join(', ')}`
      );
    }
  };
}

export function requirePermission(permission: string) {
  return async (request: FastifyRequest, reply: FastifyReply) => {
    if (!request.user) {
      throw new AuthorizationError('Authentication required');
    }
    
    if (!hasPermission(request.user.role as Role, permission)) {
      throw new AuthorizationError(
        `Missing permission: ${permission}`
      );
    }
  };
}

export function requireOwnership(
  getResourceOwnerId: (request: FastifyRequest) => Promise<string>
) {
  return async (request: FastifyRequest, reply: FastifyReply) => {
    if (!request.user) {
      throw new AuthorizationError('Authentication required');
    }
    
    const ownerId = await getResourceOwnerId(request);
    
    if (request.user.userId !== ownerId && request.user.role !== Role.ADMIN) {
      throw new AuthorizationError('You can only access your own resources');
    }
  };
}
```

#### 4. Add Course Validators
```typescript
// src/validators/course.validator.ts
import { CourseLevel, CourseStatus, CourseVisibility } from '@courses/shared';

export const courseCreateSchema = {
  type: 'object',
  required: ['title', 'description', 'level', 'price', 'currency'],
  properties: {
    title: {
      type: 'string',
      minLength: 5,
      maxLength: 100,
    },
    description: {
      type: 'string',
      minLength: 20,
      maxLength: 5000,
    },
    shortDescription: {
      type: 'string',
      maxLength: 200,
    },
    level: {
      type: 'string',
      enum: Object.values(CourseLevel),
    },
    price: {
      type: 'number',
      minimum: 0,
    },
    currency: {
      type: 'string',
      enum: ['USD', 'EUR', 'GBP'],
      default: 'USD',
    },
    tags: {
      type: 'array',
      items: { type: 'string' },
      maxItems: 10,
    },
    requirements: {
      type: 'array',
      items: { type: 'string' },
      maxItems: 20,
    },
    objectives: {
      type: 'array',
      items: { type: 'string' },
      maxItems: 20,
    },
  },
  additionalProperties: false,
} as const;

export const courseUpdateSchema = {
  type: 'object',
  properties: {
    title: {
      type: 'string',
      minLength: 5,
      maxLength: 100,
    },
    description: {
      type: 'string',
      minLength: 20,
      maxLength: 5000,
    },
    level: {
      type: 'string',
      enum: Object.values(CourseLevel),
    },
    price: {
      type: 'number',
      minimum: 0,
    },
    status: {
      type: 'string',
      enum: Object.values(CourseStatus),
    },
    visibility: {
      type: 'string',
      enum: Object.values(CourseVisibility),
    },
  },
  additionalProperties: false,
} as const;

export const enrollmentCreateSchema = {
  type: 'object',
  required: ['courseId'],
  properties: {
    courseId: {
      type: 'string',
      format: 'uuid',
    },
  },
  additionalProperties: false,
} as const;

export const quizSubmissionSchema = {
  type: 'object',
  required: ['quizId', 'answers'],
  properties: {
    quizId: {
      type: 'string',
      format: 'uuid',
    },
    answers: {
      type: 'array',
      items: {
        type: 'object',
        required: ['questionId', 'answer'],
        properties: {
          questionId: { type: 'string', format: 'uuid' },
          answer: {}, // Can be any type depending on question
        },
      },
    },
  },
  additionalProperties: false,
} as const;

export const assignmentSubmissionSchema = {
  type: 'object',
  required: ['assignmentId', 'content'],
  properties: {
    assignmentId: {
      type: 'string',
      format: 'uuid',
    },
    content: {
      type: 'string',
      minLength: 1,
      maxLength: 50000,
    },
  },
  additionalProperties: false,
} as const;
```

#### 5. Add Response Builders
```typescript
// src/utils/response.util.ts
import { IApiResponse, IPaginatedResponse, IPagination } from '@courses/shared';

export function successResponse<T>(
  data: T,
  message = 'Success'
): IApiResponse<T> {
  return {
    success: true,
    message,
    data,
  };
}

export function paginatedResponse<T>(
  data: T[],
  pagination: IPagination,
  message = 'Success'
): IPaginatedResponse<T> {
  return {
    success: true,
    message,
    data,
    pagination,
  };
}

export function errorResponse(
  code: string,
  message: string,
  details?: Record<string, unknown>
): IApiResponse {
  return {
    success: false,
    message,
    error: {
      code,
      message,
      details,
    },
  };
}
```

---

### **Phase 2: Additional Middleware (Do Next)**

#### 6. Add Rate Limiting
```typescript
// src/middleware/rate-limit.middleware.ts
import { FastifyRequest, FastifyReply } from 'fastify';
import { RateLimitError } from '../errors/app-error';

interface RateLimitConfig {
  windowMs: number; // Time window in milliseconds
  max: number;      // Max requests per window
  keyGenerator?: (request: FastifyRequest) => string;
}

const rateLimitStore = new Map<string, { count: number; resetTime: number }>();

export function rateLimit(config: RateLimitConfig) {
  const { windowMs, max, keyGenerator } = config;

  return async (request: FastifyRequest, reply: FastifyReply) => {
    const key = keyGenerator 
      ? keyGenerator(request) 
      : request.ip || 'unknown';

    const now = Date.now();
    const record = rateLimitStore.get(key);

    if (!record || now > record.resetTime) {
      rateLimitStore.set(key, {
        count: 1,
        resetTime: now + windowMs,
      });
      return;
    }

    if (record.count >= max) {
      throw new RateLimitError();
    }

    record.count++;
  };
}
```

#### 7. Add Request ID Middleware
```typescript
// src/middleware/request-id.middleware.ts
import { FastifyRequest, FastifyReply } from 'fastify';
import { randomUUID } from 'crypto';

declare module 'fastify' {
  interface FastifyRequest {
    requestId: string;
  }
}

export async function requestId(
  request: FastifyRequest,
  reply: FastifyReply
) {
  const id = request.headers['x-request-id'] as string || randomUUID();
  request.requestId = id;
  reply.header('x-request-id', id);
}
```

---

### **Phase 3: Testing (Critical)**

#### 8. Add Tests

**Test Structure:**
```
libs/common/src/
‚îú‚îÄ‚îÄ errors/
‚îÇ   ‚îî‚îÄ‚îÄ app-error.spec.ts          ‚ùå NEW
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îú‚îÄ‚îÄ auth.middleware.spec.ts    ‚ùå NEW
‚îÇ   ‚îú‚îÄ‚îÄ authorize.middleware.spec.ts ‚ùå NEW
‚îÇ   ‚îú‚îÄ‚îÄ error-handler.spec.ts      ‚ùå NEW
‚îÇ   ‚îî‚îÄ‚îÄ request-logger.spec.ts     ‚ùå NEW
‚îú‚îÄ‚îÄ validators/
‚îÇ   ‚îú‚îÄ‚îÄ base.validator.spec.ts     ‚ùå NEW
‚îÇ   ‚îî‚îÄ‚îÄ course.validator.spec.ts   ‚ùå NEW
‚îî‚îÄ‚îÄ utils/
    ‚îî‚îÄ‚îÄ response.util.spec.ts      ‚ùå NEW
```

---

## üìù Implementation Priority

### **Must Have (Week 1)**
1. ‚úÖ Remove unused scaffold files
2. ‚úÖ Add authentication middleware (JWT)
3. ‚úÖ Add authorization middleware (RBAC)
4. ‚úÖ Add course validators
5. ‚úÖ Add response builders
6. ‚úÖ Update package.json dependencies

### **Should Have (Week 2)**
7. ‚úÖ Add rate limiting middleware
8. ‚úÖ Add request ID middleware
9. ‚úÖ Add comprehensive tests
10. ‚úÖ Update README with examples

### **Nice to Have (Week 3+)**
11. ‚úÖ Add file upload utilities
12. ‚úÖ Add cache utilities
13. ‚úÖ Add API versioning helpers

---

## üì¶ Package.json Updates Needed

```json
{
  "dependencies": {
    "tslib": "^2.3.0",
    "@courses/shared": "*",
    "fastify": "*",
    "jsonwebtoken": "*"
  },
  "devDependencies": {
    "@types/jsonwebtoken": "*"
  }
}
```

---

## üé® Recommended File Structure

```
libs/common/src/
‚îú‚îÄ‚îÄ errors/
‚îÇ   ‚îú‚îÄ‚îÄ app-error.ts              ‚úÖ EXISTS
‚îÇ   ‚îî‚îÄ‚îÄ app-error.spec.ts         ‚ùå ADD
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îú‚îÄ‚îÄ auth.middleware.ts        ‚ùå ADD
‚îÇ   ‚îú‚îÄ‚îÄ authorize.middleware.ts   ‚ùå ADD
‚îÇ   ‚îú‚îÄ‚îÄ error-handler.ts          ‚úÖ EXISTS
‚îÇ   ‚îú‚îÄ‚îÄ request-logger.ts         ‚úÖ EXISTS
‚îÇ   ‚îú‚îÄ‚îÄ rate-limit.middleware.ts  ‚ùå ADD
‚îÇ   ‚îú‚îÄ‚îÄ request-id.middleware.ts  ‚ùå ADD
‚îÇ   ‚îî‚îÄ‚îÄ *.spec.ts                 ‚ùå ADD
‚îú‚îÄ‚îÄ validators/
‚îÇ   ‚îú‚îÄ‚îÄ base.validator.ts         ‚úÖ EXISTS
‚îÇ   ‚îú‚îÄ‚îÄ course.validator.ts       ‚ùå ADD
‚îÇ   ‚îî‚îÄ‚îÄ *.spec.ts                 ‚ùå ADD
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ response.util.ts          ‚ùå ADD
‚îÇ   ‚îî‚îÄ‚îÄ response.util.spec.ts     ‚ùå ADD
‚îî‚îÄ‚îÄ index.ts                      ‚úÖ EXISTS
```

---

## üìä Summary

| Feature | Status | Priority | Effort |
|---------|--------|----------|--------|
| Error Classes | ‚úÖ Done | - | - |
| Error Handler | ‚úÖ Done | - | - |
| Request Logger | ‚úÖ Done | - | - |
| Base Validators | ‚úÖ Done | - | - |
| Remove Scaffolds | ‚ùå TODO | üî¥ High | 2 min |
| Auth Middleware | ‚ùå TODO | üî¥ High | 2 hours |
| RBAC Middleware | ‚ùå TODO | üî¥ High | 1 hour |
| Course Validators | ‚ùå TODO | üî¥ High | 1 hour |
| Response Builders | ‚ùå TODO | üî¥ High | 30 min |
| Rate Limiting | ‚ùå TODO | üü° Medium | 1 hour |
| Request ID | ‚ùå TODO | üü° Medium | 15 min |
| Tests | ‚ùå TODO | üî¥ High | 6 hours |

**Estimated Total Effort:** ~14 hours for all features
**Minimum Viable:** ~4-5 hours (High priority items only)

---

## ‚úÖ Next Steps

1. **Immediate**: Remove unused scaffold files
2. **Phase 1**: Implement authentication & authorization middleware
3. **Phase 1**: Add course-specific validators
4. **Phase 1**: Add response builder utilities
5. **Phase 2**: Add rate limiting and request ID middleware
6. **Phase 3**: Create comprehensive test suite
7. **Final**: Update README with all new features
